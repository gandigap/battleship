(()=>{"use strict";var e={275:(e,t,r)=>{var o;Object.defineProperty(t,"__esModule",{value:!0}),t.NODE_ENV=t.PORT=void 0,r(81),o=process.env,t.PORT=o.PORT,t.NODE_ENV="production"},731:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class r{static gameId=0;boards;init;gameId;constructor(e,t){this.boards=e,this.init=t,this.gameId=r.gameId,console.log(`Create new game by id: ${r.gameId}`),r.gameId+=1}}t.default=r},800:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.newGameUser=t.createGame=void 0;const s=o(r(731)),a=new Map;t.createGame=()=>{const e=new s.default(new Map,0);return a.set(e.gameId,e),e.gameId},t.newGameUser=(e,t)=>{const r=a.get(e);return r?.boards.set(t,{gameId:e,turnUserId:0,ships:[],indexPlayer:t}),{idGame:e,idPlayer:t}}},489:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class r{static roomId=0;roomUsers;roomId;constructor(e){this.roomUsers=e,this.roomId=r.roomId,r.roomId+=1,console.log(`Create new room by id: ${r.roomId}`)}}t.default=r},385:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.addPlayerToRoom=t.createRoom=t.updateRooms=void 0;const s=o(r(489)),a=r(882),n=[];t.updateRooms=()=>{let e=n.findIndex((e=>2===e.roomUsers.length));for(;e>=0;)n.splice(e,1),e=n.findIndex((e=>2===e.roomUsers.length));return n},t.createRoom=e=>{const t=a.users.get(e);var r;if(r=e,n.find((({roomUsers:e})=>e.find((e=>e.index===r)))))return console.log("Player can`t create more than 1 room\n"),n;if(t){const r=new s.default([{name:t.name,index:e}]);n.push(r)}return n},t.addPlayerToRoom=(e,t)=>{const r=a.users.get(t),o=[],s=n.filter((t=>t.roomId===e)),d=s[0]?.roomUsers[0]?.index;return console.log("addUserToRoom1",r,void 0!==d,d!==t),r&&void 0!==d&&d!==t&&(o.push(d),o.push(t),console.log("addUserToRoom: if",e,t),s[0]?.roomUsers.push({name:r.name,index:t})),o}},802:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class r{static userId=0;name;password;userId;constructor(e,t){this.name=e,this.password=t,this.userId=r.userId,console.log(`Create new user by id: ${r.userId}`),r.userId+=1}}t.default=r},882:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.playerAutorization=t.winners=t.users=void 0;const s=o(r(802));t.users=new Map,t.winners=[],t.playerAutorization=e=>{const{name:r,password:o}=e.data,a={name:r,index:-1,error:!1,errorText:""};try{let e;for(const o of t.users.values())o.name===r&&(e=o);if(e)e.password===o?a.index=e.userId:(a.errorText="User exist and password is wrong",a.error=!0);else{const e=new s.default(r,o);t.users.set(e.userId,e),t.winners.push(),a.index=e.userId}return console.log(t.users),a}catch(e){return a.errorText=e instanceof Error?e.message:"Something was wromg!",a.error=!0,a}}},993:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.httpServer=void 0;const s=o(r(147)),a=r(685),n=o(r(17));t.httpServer=(0,a.createServer)(((e,t)=>{const r=n.default.resolve(n.default.dirname(""))+("/"===e.url?"/front/index.html":`/front${e.url}`);s.default.readFile(r,((e,r)=>{if(e)return t.writeHead(404),void t.end(JSON.stringify(e));t.writeHead(200),t.end(r)}))})),t.default=t.httpServer},408:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.reg="reg",e.create_game="create_game",e.start_game="start_game",e.turn="turn",e.attack="attack",e.finish="finish",e.update_room="update_room",e.update_winners="update_winners",e.create_room="create_room",e.add_user_to_room="add_user_to_room",e.add_ships="add_ships"}(r||(r={})),t.default=r},755:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=e=>{const{data:t,...r}=JSON.parse(e.toString());return console.log("message___",JSON.parse(e.toString())),{data:""===t?t:JSON.parse(t),...r}}},389:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=(e,t)=>JSON.stringify({type:e,data:JSON.stringify(t)})},691:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,s)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const d=a(r(352)),u=n(r(755)),i=r(275),l=n(r(408)),c=n(r(389)),f=r(385),m=r(882),p=r(800),_=new d.WebSocketServer({port:Number(i.PORT)});_.on("connection",(e=>{e.on("error",console.error),e.on("message",(t=>{try{const r=(0,u.default)(t),{type:o}=r,{userId:s}=e;switch(o){case l.default.reg:{const t=(0,m.playerAutorization)(r),o=(0,c.default)(l.default.reg,t);e.userId=t.index,e.send(o);const s=(0,f.updateRooms)(),a=(0,c.default)(l.default.update_room,s);e.send(a);const n=(0,c.default)(l.default.update_winners,m.winners);console.log("winnersResponse",n);break}case l.default.create_room:{const e=(0,f.createRoom)(s),t=(0,c.default)(l.default.update_room,e);_.clients.forEach((e=>{e.readyState===d.default.OPEN&&e.send(t)}));break}case l.default.add_user_to_room:{const{data:{indexRoom:t}}=r,o=(0,f.addPlayerToRoom)(t,s);if(2===o.length){const t=(0,p.createGame)();_.clients.forEach((e=>{if(e.readyState===d.default.OPEN&&(e.userId===o[0]||e.userId===o[1])){const r=(0,p.newGameUser)(t,e.userId),o=(0,c.default)(l.default.create_game,r);e.send(o)}}));const r=(0,f.updateRooms)();_.clients.forEach((t=>{if(t.readyState===d.default.OPEN){const t=(0,c.default)(l.default.update_room,r);e.send(t)}}))}console.log("roomPlayers",o);break}default:console.log("default")}}catch(e){console.log("error")}})),e.on("open",(e=>{console.log("Open",e)})),e.on("close",(e=>{console.log("Close",e)}))}))},81:e=>{e.exports=require("dotenv/config")},352:e=>{e.exports=require("ws")},147:e=>{e.exports=require("fs")},685:e=>{e.exports=require("http")},17:e=>{e.exports=require("path")}},t={};function r(o){var s=t[o];if(void 0!==s)return s.exports;var a=t[o]={exports:{}};return e[o].call(a.exports,a,a.exports,r),a.exports}(()=>{const e=r(993);r(691),console.log("Start static http server on the 8181 port!"),e.httpServer.listen(8181)})()})();