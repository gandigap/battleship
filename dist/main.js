(()=>{"use strict";var e={275:(e,t,r)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),t.NODE_ENV=t.PORT=void 0,r(81),a=process.env,t.PORT=a.PORT,t.NODE_ENV="production"},824:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createCell=void 0,t.createCell=e=>{const t=new Map;let r=0;for(let e=0;e<10;e+=1){r=10*e;for(let e=0;e<10;e+=1)t.set(r+e,{status:"",isShip:!1,ship:{},attack:0})}for(let r=0;r<e.length;r+=1){const a=e[r];a.attack=0;let s=a.position.x,o=a.position.y,n=-1,d=-1;a.direction?(n=0,d=1):(n=1,d=0);for(let e=0;e<a.length;e+=1)t.set(10*s+o,{attack:0,status:"",isShip:!0,ship:a}),s+=n,o+=d}return t},t.default=t.createCell},731:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class r{static gameId=0;boards;init;gameId;turnUserId;constructor(e,t){this.boards=e,this.init=t,this.gameId=r.gameId,r.gameId+=1}}t.default=r},800:function(e,t,r){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.doAttack=t.getTurnUserId=t.setTurnUserId=t.startGame=t.getPlayerGameData=t.addShipsToGame=t.newGameUser=t.createGame=void 0;const s=r(361),o=a(r(824)),n=a(r(731)),d=new Map;t.createGame=()=>{const e=new n.default(new Map,0);return d.set(e.gameId,e),e.gameId},t.newGameUser=(e,t)=>{const r=d.get(e);return r?.boards.set(t,{gameId:e,turnUserId:0,ships:[],indexPlayer:t,previousAttacks:[]}),{idGame:e,idPlayer:t}},t.addShipsToGame=e=>{const{data:{gameId:t,indexPlayer:r,ships:a}}=e,s=d.get(t),o=s?.boards.get(r);return o&&s?(o.ships=a,s.init+=1,{init:s.init,data:{ships:o.ships,currentPlayerIndex:r}}):null},t.getPlayerGameData=(e,t)=>{const r=d.get(e),a={};for(const e of r.boards.values())e.indexPlayer!==t&&a&&(a.ships=e.ships,a.currentPlayerIndex=e.indexPlayer);return a},t.startGame=e=>{const t=d.get(e);for(const e of t.boards.values())e.cell=(0,o.default)(e.ships)},t.setTurnUserId=(e,t)=>{d.get(e).turnUserId=t},t.getTurnUserId=e=>d.get(e).turnUserId,t.doAttack=e=>{const{data:{gameId:t,indexPlayer:r,x:a,y:o}}=e,n=d.get(t);let u=!0,i=0,l={};for(const e of n.boards.values())e.indexPlayer!==r&&(i=e.indexPlayer,l=e);const c=10*a+o,f=l.cell.get(c),p=[],m=l.previousAttacks.includes(`${a},${o}`);if(f.isShip&&!m){f.attack+=1;const e=f.ship;if(e.attack+=1,e.attack<e.length)f.status=s.AttackStatus.shot;else{f.status=s.AttackStatus.killed;let t=e.position.x-1,a=e.position.y-1,o=-1,n=-1;for(let d=0;d<3;d+=1){e.direction?(o=0,n=1):(o=1,n=0);for(let u=0;u<e.length+2;u+=1){if(t>=0&&t<=9&&a>=0&&a<=9&&(0===d||2===d)||t>=0&&t<=9&&a>=0&&a<=9&&1===d&&(0===u||u===e.length+1)){l.cell.set(10*t+a,{attack:1,status:s.AttackStatus.miss});const e={position:{x:t,y:a},currentPlayer:r,status:s.AttackStatus.miss};p.push(e)}else if(t>=0&&t<=9&&a>=0&&a<=9&&1===d&&(u>0||u<e.length+1)){l.cell.set(10*t+a,{attack:1,status:s.AttackStatus.killed});const e={position:{x:t,y:a},currentPlayer:r,status:s.AttackStatus.killed};p.push(e)}t+=o,a+=n}e.direction?(t+=1,a=e.position.y-1):(t=e.position.x-1,a+=1)}for(const e of l.cell.values())e.isShip&&""===e.status&&(u=!1)}}else f.attack+=1,f.status=s.AttackStatus.miss;return m||l.previousAttacks?.push(`${a},${o}`),{resData:{position:{x:a,y:o},currentPlayer:r,status:f.status},partnerId:i,aroundCells:p,finish:u}}},489:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class r{static roomId=0;roomUsers;roomId;constructor(e){this.roomUsers=e,this.roomId=r.roomId,r.roomId+=1}}t.default=r},385:function(e,t,r){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.addPlayerToRoom=t.createRoom=t.updateRooms=void 0;const s=a(r(489)),o=r(882),n=[];t.updateRooms=()=>{let e=n.findIndex((e=>2===e.roomUsers.length));for(;e>=0;)n.splice(e,1),e=n.findIndex((e=>2===e.roomUsers.length));return n},t.createRoom=e=>{const t=o.users.get(e);var r;if(r=e,n.find((({roomUsers:e})=>e.find((e=>e.index===r)))))return console.log("Player can`t create more than 1 room\n"),n;if(t){const r=new s.default([{name:t.name,index:e}]);n.push(r)}return n},t.addPlayerToRoom=(e,t)=>{const r=o.users.get(t),a=[],s=n.filter((t=>t.roomId===e)),d=s[0]?.roomUsers[0]?.index;return r&&void 0!==d&&d!==t&&(a.push(d),a.push(t),s[0]?.roomUsers.push({name:r.name,index:t})),a}},802:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class r{static userId=0;name;password;userId;constructor(e,t){this.name=e,this.password=t,this.userId=r.userId,r.userId+=1}}t.default=r},882:function(e,t,r){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.playerAutorization=t.winners=t.users=void 0;const s=a(r(802));t.users=new Map,t.winners=[],t.playerAutorization=e=>{const{name:r,password:a}=e.data,o={name:r,index:-1,error:!1,errorText:""};try{let e;for(const a of t.users.values())a.name===r&&(e=a);if(e)e.password===a?o.index=e.userId:(o.errorText="User exist and password is wrong",o.error=!0);else{const e=new s.default(r,a);t.users.set(e.userId,e),t.winners.push({name:r,wins:0}),o.index=e.userId}return o}catch(e){return o.errorText=e instanceof Error?e.message:"Something was wromg!",o.error=!0,o}}},993:function(e,t,r){var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.httpServer=void 0;const s=a(r(147)),o=r(685),n=a(r(17));t.httpServer=(0,o.createServer)(((e,t)=>{const r=n.default.resolve(n.default.dirname(""))+("/"===e.url?"/front/index.html":`/front${e.url}`);s.default.readFile(r,((e,r)=>{if(e)return t.writeHead(404),void t.end(JSON.stringify(e));t.writeHead(200),t.end(r)}))})),t.default=t.httpServer},408:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.reg="reg",e.create_game="create_game",e.start_game="start_game",e.turn="turn",e.attack="attack",e.finish="finish",e.update_room="update_room",e.update_winners="update_winners",e.create_room="create_room",e.add_user_to_room="add_user_to_room",e.add_ships="add_ships"}(r||(r={})),t.default=r},361:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.AttackStatus=void 0,function(e){e.miss="miss",e.killed="killed",e.shot="shot"}(r||(t.AttackStatus=r={}))},755:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=e=>{const{data:t,...r}=JSON.parse(e.toString());return{data:""===t?t:JSON.parse(t),...r}}},389:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=(e,t)=>JSON.stringify({type:e,data:JSON.stringify(t)})},691:function(e,t,r){var a=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,s)}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&a(t,e,r);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const d=o(r(352)),u=n(r(755)),i=r(275),l=n(r(408)),c=n(r(389)),f=r(385),p=r(882),m=r(800),h=new d.WebSocketServer({port:Number(i.PORT)});h.on("connection",(e=>{e.on("error",console.error),e.on("message",(t=>{try{const r=(0,u.default)(t),{type:a}=r,{userId:s}=e;switch(a){case l.default.reg:{const t=(0,p.playerAutorization)(r),a=(0,c.default)(l.default.reg,t);e.userId=t.index,e.send(a);const s=(0,f.updateRooms)(),o=(0,c.default)(l.default.update_room,s);e.send(o);const n=(0,c.default)(l.default.update_winners,p.winners);h.clients.forEach((e=>{e.readyState===d.default.OPEN&&e.send(n)}));break}case l.default.create_room:{const e=(0,f.createRoom)(s),t=(0,c.default)(l.default.update_room,e);h.clients.forEach((e=>{e.readyState===d.default.OPEN&&e.send(t)}));break}case l.default.add_user_to_room:{const{data:{indexRoom:t}}=r,a=(0,f.addPlayerToRoom)(t,s);if(2===a.length){const t=(0,m.createGame)();h.clients.forEach((e=>{if(e.readyState===d.default.OPEN&&(e.userId===a[0]||e.userId===a[1])){const r=(0,m.newGameUser)(t,e.userId),a=(0,c.default)(l.default.create_game,r);e.send(a)}}));const r=(0,f.updateRooms)();h.clients.forEach((t=>{if(t.readyState===d.default.OPEN){const t=(0,c.default)(l.default.update_room,r);e.send(t)}}))}break}case l.default.add_ships:{const{data:{gameId:t,indexPlayer:a}}=r,s=(0,m.addShipsToGame)(r);if(2===s?.init){const r=(0,m.getPlayerGameData)(t,a),{currentPlayerIndex:s}=r,o=(0,m.getPlayerGameData)(t,s),n=(0,c.default)(l.default.start_game,o);e.send(n),h.clients.forEach((e=>{if(e.readyState===d.default.OPEN&&e.userId===s){const s=(0,c.default)(l.default.start_game,r);e.send(s),(0,m.startGame)(t),(0,m.setTurnUserId)(t,a);const o={currentPlayer:a},n=(0,c.default)(l.default.turn,o);e.send(n)}}));const u={currentPlayer:a},i=(0,c.default)(l.default.turn,u);e.send(JSON.stringify(i))}break}case l.default.attack:{const{data:{gameId:t,indexPlayer:a}}=r;if(a!==(0,m.getTurnUserId)(t))return;const s=(0,m.doAttack)(r),o=s.resData,n=s.partnerId,u=(0,c.default)(l.default.attack,o);if(e.send(u),h.clients.forEach((e=>{e.readyState===d.default.OPEN&&e.userId===n&&e.send(u)})),"miss"===o.status){(0,m.setTurnUserId)(t,n);const r=(0,c.default)(l.default.turn,{currentPlayer:n});e.send(r),h.clients.forEach((e=>{e.readyState===d.default.OPEN&&e.userId===n&&e.send(r)}))}else if("killed"===o.status){const{aroundCells:t}=s;for(let r=0;r<t.length;r+=1){const a=t[r],s=(0,c.default)(l.default.attack,a);e.send(s),h.clients.forEach((e=>{e.readyState===d.default.OPEN&&e.userId===n&&e.send(s)}))}const{finish:r}=s;if(r){const t=(0,c.default)(l.default.finish,{winPlayer:a});e.send(t),h.clients.forEach((e=>{e.readyState===d.default.OPEN&&e.userId===n&&e.send(t)}))}}break}default:console.log("default")}}catch(e){console.log("error")}})),e.on("open",(e=>{console.log("Open",e)})),e.on("close",(e=>{console.log("Close",e)}))}))},81:e=>{e.exports=require("dotenv/config")},352:e=>{e.exports=require("ws")},147:e=>{e.exports=require("fs")},685:e=>{e.exports=require("http")},17:e=>{e.exports=require("path")}},t={};function r(a){var s=t[a];if(void 0!==s)return s.exports;var o=t[a]={exports:{}};return e[a].call(o.exports,o,o.exports,r),o.exports}(()=>{const e=r(993);r(691),console.log("Start static http server on the 8181 port!"),e.httpServer.listen(8181)})()})();