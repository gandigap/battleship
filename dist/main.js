(()=>{"use strict";var e={492:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(691)),a=s(993);console.log("Start static http server on the 8181 port!"),a.httpServer.listen(8181),new r.default(3e3).start()},45:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(882)),a=o(s(17)),n=o(s(389)),i=o(s(385));t.default=class{userDB;roomsDB;clientsNotify;constructor(e){this.userDB=new r.default,this.roomsDB=new i.default,this.clientsNotify=e}implementMessage(e,t){const{type:s}=e;switch(console.log("implementMessage",e),s){case a.default.reg:{const s=this.userDB.authorization(e);t.index=s.index;const o=(0,n.default)(a.default.reg,s);t.send(o);const r=this.roomsDB.getRooms(),i=(0,n.default)(a.default.update_room,r);t.send(i);const d=this.userDB.getWinners(),l=(0,n.default)(a.default.update_winners,d);this.clientsNotify(l);break}case a.default.create_room:if(this.roomsDB.addRoom(t)){const e=this.roomsDB.getRooms(),t=(0,n.default)(a.default.update_room,e);this.clientsNotify(t)}break;case a.default.add_user_to_room:{const{data:{indexRoom:s}}=e;this.roomsDB.addPlayerToRoom(t,s);const o=this.roomsDB.getRooms(),r=(0,n.default)(a.default.update_room,o);this.clientsNotify(r);break}case a.default.add_ships:{const{data:{gameId:t,indexPlayer:s,ships:o}}=e;this.roomsDB.addShipsToGame(t,s,o);break}case a.default.attack:{const{data:t}=e,{gameId:s,indexPlayer:o}=t,{x:r,y:i}=t,d=void 0!==r&&void 0!==i?{x:r,y:i}:null;if(this.roomsDB.handleAttack(s,o,d)){this.userDB.markTheWinner(o);const e=this.userDB.getWinners(),t=(0,n.default)(a.default.update_winners,e);this.clientsNotify(t)}break}default:console.log("default")}}}},385:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(198));t.default=class{rooms;constructor(){this.rooms=[]}addRoom(e){if(this.getRoomByUserId(e.index))return console.log("Player can`t create more than 1 room"),null;const t=new r.default(e);return this.rooms.push(t),t}getRoomByUserId(e){return this.rooms.find((({roomUsers:t})=>t.find((t=>t.index===e))))||null}getRooms(){return this.rooms.filter((({roomUsers:e})=>e.length<2)).map((({roomId:e,roomUsers:t})=>({roomId:e,roomUsers:t})))}addPlayerToRoom(e,t){const s=this.getRoomByRoomID(t);s?this.getRoomByUserId(e.index)?console.log("Player can`t enter his own room"):(s.roomUsers.push({name:e.name,index:e.index}),s.sockets.push(e),s.createGame()):console.log("Room isn`t exist!")}getRoomByRoomID(e){return this.rooms.find((({roomId:t})=>t===e))||null}getRoomByGameId(e){return this.rooms.find((({game:t})=>t.idGame===e))||null}addShipsToGame(e,t,s){const o=this.getRoomByGameId(e);o?o.setPlayerShips(t,s):console.log("Skipped skips adding: no room/game found")}handleAttack(e,t,s){const o=this.getRoomByGameId(e);if(!o)return void console.log("Room or game didn`t found!");const r=o.handleAttack(t,s);return r&&this.closeRoom(o.roomId),r}closeRoom(e){this.rooms=this.rooms.filter((({roomId:t})=>t!==e))}}},882:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(52));t.default=class{users;winners;constructor(){this.users=new Map,this.winners=[]}authorization(e){const{data:{name:t,password:s}}=e,o={name:t,index:-1,error:!1,errorText:""};try{let e;for(const s of this.users.values())s.name===t&&(e=s);if(e)e.password===s?o.index=e.index:(o.error=!0,o.errorText="Password is wrong!");else{const e=new r.default(t,s);this.users.set(e.index,e),this.winners.push({name:t,wins:0}),o.index=e.index}return o}catch(e){let t="Something failed";return e instanceof Error&&(t=e.message),o.error=!0,o.errorText=t,o}}getWinners(){return Array.from(this.winners.values())}markTheWinner(e){const t=this.users.get(e);this.winners=this.winners.map((({name:e,wins:s})=>e===t?.name?{name:e,wins:s+1}:{name:e,wins:s})).sort(((e,t)=>t.wins-e.wins))}}},989:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=s(361);class r{static index=0;idGame;ships;isStarted;shipsData;currentPlayer;constructor(){this.idGame=r.index,r.index+=1,this.isStarted=!1,this.ships=new Map,this.shipsData=new Map}startGame(){this.isStarted=!0,this.ships.forEach(((e,t)=>{const s=[];e.forEach((({length:e,direction:t,position:{x:r,y:a}})=>{const n={state:o.ShipState.healthy,parts:[]};for(let s=0;s<e;s+=1)n.parts.push({partShipState:o.PartShipState.healthy,x:t?r:r+s,y:t?a+s:a});s.push(n)})),this.shipsData.set(t,s)}))}setCurrentPlayer(e){this.currentPlayer=e}getCurrentPlayer(){return this.currentPlayer}handleAttack(e,t,s){const o=s;return{currentPlayer:e,position:o,status:this.processAttack(t,o)}}processAttack(e,t){const s=this.shipsData.get(e);let r=o.AttackResult.miss;const a=s.map((({state:e,parts:s})=>{let a=e,n=s.map((({partShipState:e,x:s,y:n})=>{let i=e;return t?.x===s&&t.y===n&&(i=o.PartShipState.damaged,a=o.ShipState.damaged,r=o.AttackResult.shot),{partShipState:i,x:s,y:n}}));return n.length>0&&n.every((({partShipState:e})=>e===o.PartShipState.damaged))&&(n=[],a=o.ShipState.sunk,r=o.AttackResult.killed),{state:a,parts:n}}));return this.shipsData.set(e,a),r}checkEndOfGame(e){return this.shipsData.get(e).every((({state:e})=>e===o.ShipState.sunk))}}t.default=r},993:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.httpServer=void 0;const r=o(s(147)),a=s(685),n=o(s(822));t.httpServer=(0,a.createServer)(((e,t)=>{const s=n.default.resolve(n.default.dirname(""))+("/"===e.url?"/front/index.html":`/front${e.url}`);r.default.readFile(s,((e,s)=>{if(e)return t.writeHead(404),void t.end(JSON.stringify(e));t.writeHead(200),t.end(s)}))})),t.default=t.httpServer},198:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(989)),a=o(s(17)),n=s(361),i=o(s(389));class d{static index=0;roomId;roomUsers;sockets;game;endOfGame=!1;attackInProcess=!1;constructor(e){this.roomUsers=[],this.sockets=[];const{name:t,index:s}=e;this.roomId=d.index,this.roomUsers.push({name:t,index:s}),this.sockets.push(e),d.index+=1}createGame(){this.game=new r.default,this.sockets.forEach((e=>{const t={idGame:this.game.idGame,idPlayer:e.index},s=(0,i.default)(a.default.create_game,t);console.log(`Responded inside room: ${s}`),e.send(s)}))}setPlayerShips(e,t){if(0===this.game.ships.size&&this.game.setCurrentPlayer(e),this.game.ships.set(e,t),2===this.game.ships.size){this.game.startGame();const e=this.game.getCurrentPlayer();this.sockets.forEach((t=>{const s={currentPlayerIndex:e,ships:this.game.ships.get(t.index)},o=(0,i.default)(a.default.start_game,s);console.log(`Responded inside room: ${o}`),t.send(o)}))}}handleAttack(e,t){if(this.attackInProcess||this.endOfGame)return console.log("Skipped attack: other attack in process or end of game"),!1;if(this.game.getCurrentPlayer()!==e)return console.log("Skipped attack: not players turn"),!1;this.attackInProcess=!0;const s=this.getOtherPlayer(e),o=this.game.handleAttack(e,s,t);return this.endOfGame=this.game.checkEndOfGame(s),this.sockets.forEach((t=>{const r=(0,i.default)(a.default.attack,o);if(console.log(`Responded inside room: ${r}`),t.send(r),o.status===n.AttackResult.miss){this.game.setCurrentPlayer(s);const e=(0,i.default)(a.default.turn,{currentPlayer:s});console.log(`Responded inside room: ${e}`),t.send(e)}if(this.endOfGame){const s=(0,i.default)(a.default.finish,{winPlayer:e});console.log(`Responded inside room: ${s}`),t.send(s)}})),this.attackInProcess=!1,this.endOfGame}forceEndGame(e){const t=this.getOtherPlayer(e),s=this.sockets.find((({index:e})=>e===t));if(!this.game.isStarted){const e={currentPlayerIndex:t,ships:this.game.ships.get(t)},o=(0,i.default)(a.default.start_game,e);console.log(`Responded personally: ${o}`),s.send(o)}const o=(0,i.default)(a.default.finish,{winPlayer:t});return console.log(`Responded personally: ${o}`),s.send(o),t}getOtherPlayer(e){return this.roomUsers.find((({index:t})=>t!==e))?.index}}t.default=d},17:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.reg="reg",e.create_game="create_game",e.start_game="start_game",e.turn="turn",e.attack="attack",e.finish="finish",e.update_room="update_room",e.update_winners="update_winners",e.create_room="create_room",e.add_user_to_room="add_user_to_room",e.add_ships="add_ships"}(s||(s={})),t.default=s},361:(e,t)=>{var s,o,r,a;Object.defineProperty(t,"__esModule",{value:!0}),t.AttackResult=t.ShipType=t.ShipState=t.PartShipState=void 0,function(e){e.healthy="healty",e.damaged="damaged"}(s||(t.PartShipState=s={})),function(e){e.healthy="healty",e.damaged="damaged",e.sunk="sunk"}(o||(t.ShipState=o={})),function(e){e.small="small",e.medium="medium",e.large="large",e.huge="huge"}(r||(t.ShipType=r={})),function(e){e.miss="miss",e.killed="killed",e.shot="shot"}(a||(t.AttackResult=a={}))},52:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class s{static index=0;name;password;index;constructor(e,t){this.name=e,this.password=t,this.index=s.index,s.index+=1}}t.default=s},755:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=e=>{const{data:t,...s}=JSON.parse(e.toString());return console.log("message___",JSON.parse(e.toString())),{data:""===t?t:JSON.parse(t),...s}}},389:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=(e,t)=>JSON.stringify({type:e,data:JSON.stringify(t)})},691:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(352),a=o(s(755)),n=o(s(45));t.default=class{port;server;controller;constructor(e){this.port=e,this.server=new r.WebSocketServer({port:e}),this.controller=new n.default(this.clientsNotify.bind(this))}clientsNotify(e){this.server.clients.forEach((t=>{t.readyState===r.WebSocket.OPEN&&t.send(e)}))}start(){this.server.on("connection",(e=>{e.on("error",console.error),e.on("message",(t=>{try{const s=(0,a.default)(t);this.controller.implementMessage(s,e)}catch(e){console.log("error")}})),e.on("open",(e=>{console.log("Open",e)})),e.on("close",(e=>{console.log("Close",e)})),e.on("listening",(()=>{console.log(`WebSocker server on the ${this.port} port!`)}))}))}}},352:e=>{e.exports=require("ws")},147:e=>{e.exports=require("fs")},685:e=>{e.exports=require("http")},822:e=>{e.exports=require("path")}},t={};!function s(o){var r=t[o];if(void 0!==r)return r.exports;var a=t[o]={exports:{}};return e[o].call(a.exports,a,a.exports,s),a.exports}(492)})();