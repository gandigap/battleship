(()=>{"use strict";var e={492:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(691)),a=s(993);console.log("Start static http server on the 8181 port!"),a.httpServer.listen(8181),new r.default(3e3).start()},45:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(882)),a=o(s(17)),n=o(s(389)),i=o(s(385));t.default=class{userDB;roomsDB;clientsNotify;constructor(e){this.userDB=new r.default,this.roomsDB=new i.default,this.clientsNotify=e}implementMessage(e,t){const{type:s}=e;switch(console.log("implementMessage",e),s){case a.default.reg:{const s=this.userDB.authorization(e);t.index=s.index;const o=(0,n.default)(a.default.reg,s);t.send(o);const r=this.userDB.getWinners(),i=(0,n.default)(a.default.update_winners,r);this.clientsNotify(i);break}case a.default.create_room:if(this.roomsDB.addRoom(t)){const e=this.roomsDB.getRooms(),t=(0,n.default)(a.default.update_room,e);this.clientsNotify(t)}break;case a.default.add_user_to_room:{const{data:{indexRoom:s}}=e;this.roomsDB.addPlayerToRoom(t,s);const o=this.roomsDB.getRooms(),r=(0,n.default)(a.default.update_room,o);this.clientsNotify(r);break}case a.default.add_ships:{const{data:{gameId:t,indexPlayer:s,ships:o}}=e;this.roomsDB.addShipsToGame(t,s,o);break}default:console.log("default")}}}},385:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(198));t.default=class{rooms;constructor(){console.log(" New rooms DB"),this.rooms=[]}addRoom(e){const t=this.getRoomByUserId(e.index);if(console.log("existRoom",t),t)return console.log("Player can`t create more than 1 room"),null;const s=new r.default(e);return this.rooms.push(s),s}getRoomByUserId(e){return console.log("getRoomByUserId",e,this.rooms,this.rooms.length),this.rooms.find((({roomUsers:t})=>t.find((t=>t.index===e))))}getRooms(){return this.rooms.filter((({roomUsers:e})=>e.length<2)).map((({roomId:e,roomUsers:t})=>({roomId:e,roomUsers:t})))}addPlayerToRoom(e,t){const s=this.getRoomByRoomID(t);s?this.getRoomByUserId(e.index)?console.log("Player can`t enter his own room"):(s.roomUsers.push({name:e.name,index:e.index}),s.sockets.push(e),s.createGame()):console.log("Room isn`t exist!")}getRoomByRoomID(e){return this.rooms.find((({roomId:t})=>t===e))}getRoomByGameId(e){return this.rooms.find((({game:t})=>t.idGame===e))}addShipsToGame(e,t,s){const o=this.getRoomByGameId(e);o?o.setPlayerShips(t,s):console.log("Room isn`t exist!")}}},882:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(52));t.default=class{users;winners;constructor(){this.users=new Map,this.winners=new Map}authorization(e){const{data:{name:t,password:s}}=e,o={name:t,index:-1,error:!1,errorText:""};try{let e;for(const s of this.users.values())s.name===t&&(e=s);if(e)e.password===s?o.index=e.index:(o.error=!0,o.errorText="Password is wrong!");else{const e=new r.default(t,s);this.users.set(e.index,e),this.winners.set(e.index,{name:t,wins:0}),o.index=e.index}return o}catch(e){let t="Something failed";return e instanceof Error&&(t=e.message),o.error=!0,o.errorText=t,o}}getWinners(){return Array.from(this.winners.values())}}},989:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=s(361);class r{static index=0;idGame;ships;isStarted;shipsData;currentPlayer;constructor(){this.idGame=r.index,r.index+=1,this.isStarted=!1,this.ships=new Map,this.shipsData=new Map}startGame(){this.isStarted=!0,this.ships.forEach(((e,t)=>{const s=[];e.forEach((({length:e,direction:t,position:{x:r,y:a}})=>{const n={state:o.ShipState.Healthy,parts:[]};for(let s=0;s<e;s+=1)n.parts.push({partState:o.PartState.Healthy,x:t?r:r+s,y:t?a+s:a});s.push(n)})),this.shipsData.set(t,s)}))}setCurrentPlayer(e){this.currentPlayer=e}getCurrentPlayer(){return this.currentPlayer}}t.default=r},993:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.httpServer=void 0;const r=o(s(147)),a=s(685),n=o(s(822));t.httpServer=(0,a.createServer)(((e,t)=>{const s=n.default.resolve(n.default.dirname(""))+("/"===e.url?"/front/index.html":`/front${e.url}`);r.default.readFile(s,((e,s)=>{if(e)return t.writeHead(404),void t.end(JSON.stringify(e));t.writeHead(200),t.end(s)}))})),t.default=t.httpServer},198:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(989)),a=o(s(17)),n=o(s(389));class i{static index=0;roomId;roomUsers;sockets;game;constructor(e){this.roomUsers=[],this.sockets=[];const{name:t,index:s}=e;this.roomId=i.index,this.roomUsers.push({name:t,index:s}),this.sockets.push(e),i.index+=1}createGame(){this.game=new r.default,this.sockets.forEach((e=>{const t={idGame:this.game.idGame,idPlayer:this.roomUsers.find((({index:t})=>t!==e.index))?.index},s=(0,n.default)(a.default.create_game,t);e.send(s)}))}setPlayerShips(e,t){if(0===this.game.ships.size&&this.game.setCurrentPlayer(e),this.game.ships.set(e,t),2===this.game.ships.size){this.game.startGame();const e=this.game.getCurrentPlayer();this.sockets.forEach((t=>{const s={currentPlayerIndex:e,ships:this.game.ships.get(t.index)},o=(0,n.default)(a.default.start_game,s);console.log(`Responded inside room: ${o}`),t.send(o)}))}}}t.default=i},17:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.reg="reg",e.create_game="create_game",e.start_game="start_game",e.turn="turn",e.attack="attack",e.finish="finish",e.update_room="update_room",e.update_winners="update_winners",e.create_room="create_room",e.add_user_to_room="add_user_to_room",e.add_ships="add_ships"}(s||(s={})),t.default=s},361:(e,t)=>{var s,o,r;Object.defineProperty(t,"__esModule",{value:!0}),t.ShipType=t.ShipState=t.PartState=void 0,function(e){e.Healthy="healty",e.Damaged="damaged"}(s||(t.PartState=s={})),function(e){e.Healthy="healty",e.Damaged="damaged",e.Sunk="sunk"}(o||(t.ShipState=o={})),function(e){e.small="small",e.Medium="medium",e.Large="large",e.huge="huge"}(r||(t.ShipType=r={}))},52:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class s{static index=0;name;password;index;constructor(e,t){this.name=e,this.password=t,this.index=s.index,s.index+=1}}t.default=s},755:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=e=>{const{data:t,...s}=JSON.parse(e.toString());return console.log("message___",JSON.parse(e.toString())),{data:""===t?t:JSON.parse(t),...s}}},389:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=(e,t)=>JSON.stringify({type:e,data:JSON.stringify(t)})},691:function(e,t,s){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(352),a=o(s(755)),n=o(s(45));t.default=class{port;server;controller;constructor(e){this.port=e,this.server=new r.WebSocketServer({port:e}),this.controller=new n.default(this.clientsNotify.bind(this))}clientsNotify(e){this.server.clients.forEach((t=>{t.readyState===r.WebSocket.OPEN&&t.send(e)}))}start(){this.server.on("connection",(e=>{e.on("error",console.error),e.on("message",(t=>{try{const s=(0,a.default)(t);this.controller.implementMessage(s,e)}catch(e){console.log("error")}})),e.on("open",(e=>{console.log("Open",e)})),e.on("close",(e=>{console.log("Close",e)})),e.on("listening",(()=>{console.log(`WebSocker server on the ${this.port} port!`)}))}))}}},352:e=>{e.exports=require("ws")},147:e=>{e.exports=require("fs")},685:e=>{e.exports=require("http")},822:e=>{e.exports=require("path")}},t={};!function s(o){var r=t[o];if(void 0!==r)return r.exports;var a=t[o]={exports:{}};return e[o].call(a.exports,a,a.exports,s),a.exports}(492)})();